{
    "contents" : "---\ntitle: \"EEPC Aggregate Loss Model:DRAFT\"\nauthor: \"CDEEO\"\ndate: \"Thursday, July 02, 2015\"\noutput: html_document\n---\n```{r,echo=FALSE}\nlibrary(knitr)\nopts_chunk$set(echo=FALSE,message=F)\n```\n\n###Data Source: [EEPC Annual Reports 2002-2010][EEPC]\n###Summary Statistics on Cost\n1. Overall   \n```{r}\nEEPC <- read.csv(\"../Data/EEPC Risk Analysis.csv\", stringsAsFactors=FALSE)\nTotal <- read.csv(\"../Data/EEPC Total.csv\", stringsAsFactors=FALSE)\nset.seed(123)\n\nlibrary(moments)\nlibrary(MASS)\nlibrary(dplyr)\nlibrary(GLDEX)\n\nEEPC %>% summarise(mean=mean(Amount), standard_dev=sd(Amount), \n                   median= median(Amount),skewness=skewness(Amount),\n                   kurtosis=kurtosis(Amount))\n\n```\n\n2. By Year\n```{r,fig.height=12,fig.width=12}\nEEPC %>% group_by(year.settled) %>% \n    summarise(mean=mean(Amount), total=sum(Amount), standard_dev=sd(Amount),\n              median= median(Amount),skewness=skewness(Amount),\n              kurtosis=kurtosis(Amount))\npar(mfrow=c(3,3))\nfor(y in 2002:2010){\n    cost=EEPC[EEPC$year.settled==y,\"Amount\"]\n    hist(cost,col=sample(colors(),1),breaks = 25,\n         main=y,xaxt=\"n\",\n         xlab=\"EEPC Law Suit Cost (in thousands)\",\n         xlim=c(0,quantile(cost,.99)))\n    xrange=seq.int(0,quantile(cost,.99),length.out = 6)\n    xlabel=paste(\"$\",round(xrange/1e3),sep=\"\")\n    axis(1,at=xrange,labels = xlabel)\n}\n\n```\n\n             \n###Severity Loss Probability Model   \n**1. Exponential Distribution**       \n```{r}\nN=nrow(EEPC)\nexp_rate=fitdistr(EEPC$Amount,densfun = \"exponential\")\nexp_rate$estimate\npar(mfrow=c(1,1))\nhist(EEPC$Amount,xlim = c(0,1e6),breaks = 5e2,freq = F,\n     main=\"Histogram with Exponential Distribution\",\n     col=\"green\",xaxt=\"n\",yaxt=\"n\",\n     xlab=\"EEPC Law Suit Cost (in thousands)\")\nxrange=seq.int(0,1e6,by = 100)\nyexp=dexp(xrange,exp_rate$estimate)\nlines(x = xrange,y = yexp,lwd=3,col=\"blue\")\nxrange=seq.int(0,1e6,by = 2e5)\nxlabel=paste(\"$\",xrange/1000,sep=\"\")\naxis(1,at=xrange,labels = xlabel)\nyrange=seq.int(0,1.2e-5,by = 2e-6)\nylabel=paste(yrange*100,\"%\",sep=\"\")\naxis(2,at=yrange,labels = ylabel)\n\n\n```\n\n###Diagnostic against Exponential Model  \n**QQplot**    \n```{r}\nrand_exp=rexp(1e5,rate = exp_rate$estimate)\nexprange=c(0,1e6)\nqqplot(EEPC$Amount,rand_exp,col=\"darkgrey\",pch=19,xlim=exprange,ylim=exprange,\n       ylab=\"Exponential Distribution\",xlab=\"EEPC Law Suit Costs\",main=\"QQ-plot\")\nabline(0,1,col=\"red\",lty=3,lwd=2)\n```\n\n###Kolmogorov-Smirnov (K-S) test   \n```{r}\nks.gof(EEPC$Amount,\"pexp\",rate = exp_rate$estimate)\n```\n\n**Both diagnostics show that there is a signifcant departure from the Exponential Model** \n\n\n###2. LogNormal Distribution\n```{r}\nEEPC$LogAmount=log(EEPC$Amount)\nlnorm_rate=fitdistr(EEPC$Amount,densfun = \"log-normal\")\nlnorm_rate$estimate\nhist(EEPC$Amount,xlim = c(0,1e6),breaks = 5e2,freq = F,\n     main=\"Histogram with Log-Normal Distribution\",\n     col=\"yellow\",xaxt=\"n\",yaxt=\"n\",ylim=c(0,1.4e-5),\n     xlab=\"EEPC Law Suit Cost (in thousands)\")\nxrange=seq.int(0,1e6,by = 100)\nylog=dlnorm(xrange,meanlog = lnorm_rate$estimate[\"meanlog\"],\n            sdlog = lnorm_rate$estimate[\"sdlog\"])\nlines(x = xrange,y = ylog,lwd=3,col=\"purple\")\nxrange=seq.int(0,1e6,by = 2e5)\nxlabel=paste(\"$\",xrange/1000,sep=\"\")\naxis(1,at=xrange,labels = xlabel)\nyrange=seq.int(0,1.4e-5,by = 2e-6)\nylabel=paste(yrange*100,\"%\",sep=\"\")\naxis(2,at=yrange,labels = ylabel)\n\n\nnorm_rate=fitdistr(EEPC$LogAmount,densfun = \"normal\")\nhist(EEPC$LogAmount,freq = F,xlim = c(6,14),breaks = 20,\n     main=\"Histogram with Normal Distribution\",\n     col=\"pink\",yaxt=\"n\",\n     xlab=\"EEPC Law Suit Cost (Log Scale)\")\nxrange=seq.int(0,18,by = .1)\nynorm=dnorm(xrange,mean = norm_rate$estimate[\"mean\"],\n            sd = norm_rate$estimate[\"sd\"])\nlines(x = xrange,y = ynorm,lwd=3,col=\"darkgreen\")\n\nyrange=seq.int(0,0.4,by = 0.05)\nylabel=paste(yrange*100,\"%\",sep=\"\")\naxis(2,at=yrange,labels = ylabel,las=2,cex=.5)\n\n```\n\n###Diagnostic   \n\n```{r}\nrand_lnorm=rlnorm(1e5,meanlog = lnorm_rate$estimate[\"meanlog\"],\n                 sdlog = lnorm_rate$estimate[\"sdlog\"])\nexprange=c(0,1e6)\nqqplot(EEPC$Amount,rand_lnorm,\n       col=\"darkblue\",pch=19,xlim=exprange,ylim=exprange,\n       ylab=\"LogNormal Distribution\",xlab=\"EEPC Law Suit Costs\",main=\"QQ-plot\")\nabline(0,1,col=\"red\",lty=3,lwd=3)\n```\n\n###Kolmogorov-Smirnov (K-S) test   \n```{r}\nks.gof(EEPC$Amount,\"plnorm\",meanlog = lnorm_rate$estimate[\"meanlog\"],\n       sdlog = lnorm_rate$estimate[\"sdlog\"])\n```\n\n**Diagnostics show that there is not a significant level of evidence to reject the LogNormal Model for Severity of Loss.**       \n\n###Loss Frequence Model\n             \n```{r}\nyear=EEPC %>% group_by(year.settled) %>% summarise(AvgAmount=mean(Amount),N=n())\nyear %>% summarise(Avg=mean(N),Var=var(N),Median=median(N),\n                   skewness(N),kurtosis(N))\nbarplot(year$N,names.arg =year$year.settled,col=sample(colors(),1),\n        xlab=\"year\",main=\"Number of cases settled\")\n```\n\n**Because sample variance is much larger than sample mean: use Negative Binomial**                \n```{r}\nnb_param=fitdistr(year$N,\"Negative Binomial\")\nnb_param$estimate\n```\n\n\n###Kolmogorov-Smirnov (K-S) test   \n```{r}\nks.gof(year$N,\"pnbinom\",size = nb_param$estimate[\"size\"],\n       mu = nb_param$estimate[\"mu\"])\n```\n\n**Diagnostics show that there is not a significant level of evidence to reject the Negative Binomial Model for Loss Frequency.**     \n\n###Aggregated Loss Model using Monte Carlo Simulation\n\n```{r}\ntotal_cost=rep(0,5e4)\nfor(j in 1:5e4){\n    num_cases=rnbinom(n=1,size = nb_param$estimate[\"size\"],\n                      mu = nb_param$estimate[\"mu\"])\n    law_suit_cost=0\n    for(i in 1:num_cases){\n        law_suit_cost=law_suit_cost+\n            rlnorm(n = 1,meanlog=lnorm_rate$estimate[\"meanlog\"],\n                   sdlog = lnorm_rate$estimate[\"sdlog\"])\n    }\n    total_cost[j]=law_suit_cost\n}\n\nsummary(total_cost)\nlnorm_param=fitdistr(total_cost,densfun = \"log-normal\")\nlnorm_param$estimate\n\nhist(total_cost,breaks = 50,freq = F,\n     main=\"Aggregated Loss Distribution\",\n     col=\"grey\",ylim=c(0,2.5e-7),xaxt=\"n\",#yaxt=\"n\",\n     xlab=\"Total Cost (in millions)\")\nxrange=seq.int(0,1e8,by = 100)\nylnorm=dlnorm(xrange,meanlog = lnorm_param$estimate[\"meanlog\"],\n            sdlog = lnorm_param$estimate[\"sdlog\"])\nlines(x = xrange,y = ylnorm,lwd=3,col=\"darkgreen\")\nxrange=seq.int(0,3.5e7,by = 5e6)\nxlabel=paste(\"$\",xrange/1e6,sep=\"\")\naxis(1,at=xrange,labels = xlabel)\n\n```        \n\n###Comparsion of the Simulated Aggregated Loss with Actual Loss   \n\n```{r}\nlibrary(gridExtra)\nAggregated_Loss=c(summary(total_cost),skewness=round(skewness(total_cost),1),\n                  kurtosis=round(kurtosis(total_cost),1))\nAcutal_Loss=c(summary(Total$Total),skewness=round(skewness(Total$Total),1),\n                  kurtosis=round(kurtosis(Total$Total),1))\ng=data.frame(Aggregated_Loss,Acutal_Loss)\ng=tableGrob(g)\ngrid.draw(g)\n```\n\n###Actual Aggregated Loss\n```{r}\nhist(Total$Total,breaks = 20,freq = F,\n     main=\"Actual Aggregated Loss\",\n     col=\"orchid\",xaxt=\"n\",#yaxt=\"n\",\n     xlab=\"Total Cost (in millions)\")\n\nxrange=seq.int(0,3.5e7,by = 5e6)\nxlabel=paste(\"$\",xrange/1e6,sep=\"\")\naxis(1,at=xrange,labels = xlabel)\n```        \n      \n###Diagnostic of the Aggregated Loss Model Against Actual Aggregated Loss    \n\n```{r}\nrand_lnorm=rlnorm(1e5,meanlog = lnorm_param$estimate[\"meanlog\"],\n                  sdlog = lnorm_param$estimate[\"sdlog\"])\nexprange=c(0,2e7)\nqqplot(Total$Total,rand_lnorm,col=\"green\",pch=19,xlim=exprange,ylim=exprange,\n       ylab=\"Aggregated Loss Model\",xlab=\"Actual Aggregated Loss\",main=\"QQ-plot\")\nabline(0,1,col=\"red\",lty=3,lwd=3)\n```\n\n###Kolmogorov-Smirnov (K-S) test     \n```{r}\nks.gof(Total$Total,\"plnorm\",meanlog = lnorm_param$estimate[\"meanlog\"],\n       sdlog = lnorm_param$estimate[\"sdlog\"])\n```\n\n###VaR: \n\n**The Value at Risk at 95% confident Interval for one year aggregated loss is `r paste0(\"$\",round(quantile(total_cost,c(.95))/1e6))` millions of dollars**    \n\n**The Value at Risk at 99% confident Interval for one year aggregated loss is `r paste0(\"$\",round(quantile(total_cost,c(.99))/1e6))` millions of dollars**   \n\n###Expected Shortfall   \n**The expected amount of aggregated loss given that the loss is beyond the confident Interval**   \n```{r}\nslice = 5e4\nslice.seq=seq(from = .95,to = 1,length.out = slice)\n\n```\n\n**The Expected Shortfall at 95% confident Interval is `r paste0(\"$\",round(mean(quantile(total_cost,slice.seq))/1e6))` millions of dollars** \n\n```{r}\nslice.seq=seq(from = .99,to = 1,length.out = slice)\n```\n\n**The Expected Shortfall at 99% confident Interval is `r paste0(\"$\",round(mean(quantile(total_cost,slice.seq))/1e6))` millions of dollars**  \n\n\n[EEPC]:http://www.nyc.gov/html/eepc/html/home/annual-reports.shtml",
    "created" : 1436401136531.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3907816717",
    "id" : "60BFB32B",
    "lastKnownWriteTime" : 1436401150,
    "path" : "~/GitHub/EEPC_Risk_Analysis/Risk Analysis/Code/EEPC.Rmd",
    "project_path" : "EEPC.Rmd",
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_markdown"
}